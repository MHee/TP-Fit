<!DOCTYPE html>
<html>
<head>
<title>hackerguide.html</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
</head>
<body>
<h1>TP-Fit Hacker Guide</h1>
<h2>1. Introduction</h2>
<p>The TP-Fit Hacker Guide gives in depth information about the low level functions of TP-Fit. This guide is not intended for the regular
user, but for people who are confident they know what they do. Please
do not make any changes to a production installation of TP-Fit. Only
change your private working copy and consider to submit changes that
you found useful for inclusion in future official releases of TP-Fit.</p>
<h2>2. Theory &amp; Data </h1></h2>
<p>This section describes how to work with TP-Fit reference models.        <br />
TP-Fit reference models are stored in look-up tables that are stored in Matlab
*.mat files on disc. It is possible to load this tables by using the
Matlab load function or by just drag and drop the *.mat files,
containing a single structure variable M, on the command window.
However, it is recommended to use the <code>LoadModel(ModelType)</code> function (type <code>help LoadModel</code> for details), to access these models. If the model locations or names will change, only <code>LoadModel</code> has to be adapted to keep all depending code working. To load the DVTP reference temperature table type:</p>
<p><code>M=LoadModel('DVTP_T');</code></p>
<p>The APCT table can be loaded with</p>
<p><code>M=LoadModel('APCT_T');</code></p>
<h3>The table structure</h3>
<p>The lookup table structure <code>M</code> contains the following fields:</p>
<pre><code>M = 

  ks: [1x21 double]
 rcs: [1x21 double]
   k: [21x21 double]
  rc: [21x21 double]
   T: {21x21 cell}
   t: [1x201 double]
Info: [1x1 struct]
</code></pre>

<p>The vectors <code>ks</code> and <code>rcs</code> contain a list of all different sediment thermal conductivities (ks) and volumetric heat capacities (rcs) provided in the lookup tables. See the following subsets of ks and rcs:</p>
<pre><code>ks=M.ks([1:3 end-1:end])
rcs=M.rcs([1:3 end-1:end])

ks =

    0.5000    0.6000    0.7000    2.4000    2.5000


rcs =

 2300000     2400000     2500000     4200000     4300000
</code></pre>

<p>The tables (matrices) k and rc contain somewhat redundant
information and are provided for security/convenience. They contain the
values in ks and rcs ordered in a 2D lookup table (k increasing with
rows and rc increasing with columns). Compare the results of the
following commands with the ks and rcs printed above:</p>
<pre><code>i=3;
j=2;
k=M.k(i,j)
        0.7000

rc=M.rc(i,j)
        2400000
</code></pre>

<p>A vector of reference temperatures corresponding to k and rc can be retrieved by:</p>
<pre><code>T=M.T{i,j};
</code></pre>

<p>Temperatures are stored in an array of cells ({i,j} and not (i,j)!!!). The DVTP model also contains the field <code>T2</code> which contains model temperatures at the location of the second thermistor.</p>
<p>The model times, stored in the vector M.t, are not necessarily equidistant! Most models use a logarithmic time scale:</p>
<pre><code>t=M.t;
tStart=t(1:3)
    0    0.0100    0.0108

tEnd=t(end-2:end)
    1.0e+005 *
            0.8504    0.9222    1.0000

TStart=T(1:3)
    1.0000    1.0002    1.0002

TEnd=T(end-2:end)
        0.0011    0.0008    0.0005
</code></pre>

<p>Furthermore, <code>LoadModel</code> adds the location from where the model was loaded to the <code>M.Info</code> field which can contain also other optional information regarding the model:</p>
<pre><code>M.Info.ModelFile
    D:\home\martin\TODP\APC3\TP-Fit\MatLab\TP-Fit\RefModels\APCT_TModels.mat
</code></pre>

<h3>High-level reference model access</h3>
<p>The model table structure, contained in <code>M</code>, is difficult to handle, since times are not equidistant, and the structure of the tables may change in the future. Therfore, it is recommended to access the reference models through the &quot;high-level&quot; function <code>GetRefDecay</code>, if possible!</p>
<p>Below, several examples of GetRefDecay calls are shown and the resulting RefData is compared in a plot.</p>
<p>If called without parameters <code>GetRefDecay</code>
will use a set of standard parameters. A APCT temperature model with
sediment thermal conductivity k=1 and volumetric heat capacity rc=3.5e6
will be returned. The temperatures T are still at the same times t (not
equidistant) as in the model *.mat file. The Info field of the <code>M</code> structure (see above) is stored in the <code>ModelInfo</code> field.</p>
<pre><code>RefData{1}=GetRefDecay;
disp(RefData{1});
            k: 1
           rc: 3500000
            t: [1x201 double]
            T: [1x201 double]
    ModelType: 'APCT_T'
    ModelInfo: [1x1 struct]
</code></pre>

<p>To get a reference model corresponding to certain parameters, both parameters have to be provided (<code>GetRefDecay(k,rc)</code>). If two output variables are requested, <code>GetRefDecay</code> also returns the table structure <code>M</code> that was loaded. The parameters have to be in the range of the table, otherwise NaNs are returned. If the parameters are in between table entries, the closest entries are chosen by default (see warning):
	[RefData{2},M]=GetRefDecay(1.08,3.55e6);
		Warning: k not in model lookup table. Unsing closest!</p>
<pre><code>k=RefData{2}.k
    1.1000

rc=RefData{2}.rc
    3.6000e+006
</code></pre>

<p>It is also possible to interpolate between closest table entries (<code>,'InterpProps',true</code>) instead. But this &quot;3D&quot; interpolation is rather slow!</p>
<p>Also, for every call of <code>GetRefDecay</code> the reference table has to be loaded from disc. If you want to get many models from the <code>same</code> table it is possible to speed things up by retrieving the table (<code>M</code>) during the first call (see above) and reuse it with (<code>,'M',M</code>).</p>
<pre><code>RefData{3}=GetRefDecay(1.08,3.55e6,'InterpProps',true,'M',M);
k=RefData{3}.k
    1.0800

rc=RefData{3}.rc
    3550000
</code></pre>

<p>All the data above is still at original model times. If you want the model at specific times (e.g. from 0s to 300s in 10s
intervals), time interpolation is enabled using the <code>'ts'</code> parameter. Time interpolation is much faster than parameter interpolation (both types of interpolation can be combined!).</p>
<pre><code>RefData{4}=GetRefDecay(2.08,4.2e6,'InterpProps',true,'ts',0:10:300);
</code></pre>

<p>To load a model other than the APCT temperature model the model type (see <code>LoadModel</code>) has to be specified, explicitly. Using the DVTP Model it is also possible to retrieve the temperatures of the second sensor (<code>,'GetT2',true</code>).</p>
<pre><code>RefData{5}=GetRefDecay(1,3.5e6,'ModelType','DVTP_T','GetT2',true);
disp(RefData{5});
            k: 1
           rc: 3500000
            t: [1x201 double]
            T: [1x201 double]
           T2: [1x201 double]
    ModelType: 'DVTP_T'
    ModelInfo: [1x1 struct]
</code></pre>

<p>To get a nice ASCII table of the reference model use the <code>Print</code> option (<code>,'Print',true</code>) if you specify an additional filename (<code>,'FileName','MyOutFile.dat'</code>) the ASCII-table is dumped to the file instead to the promt:</p>
<pre><code>GetRefDecay(1,3.5e6,'ts',[0:10:50],'Print',true);
    APCT-3 Model: k= 1.00 (W/(m K)); rc= 3.50 (MJ/ m^3 K)
        t (s)   T (°C)
        0.000000    1.000000
        10.000000   0.711148
        20.000000   0.618901
        30.000000   0.560470
        40.000000   0.518053
        50.000000   0.485129
</code></pre>

<h3>Graphical model comparison</h3>
<p><img src="images/workingwithreferencemodels_01.png" alt="RefModelPlot" /></p>
<p>Each line numbered in the legend corresponds to the <code>RefData{i}</code> of the previous section. The dotted line shows the second thermistor of
the DVTP model. The lower plot high-lights the interpolation of thermal
properties. The upper and the lower lines are straight from the look-up
table, while the red line is interpolated between these two. Also, the
different sampling rates/intervals can be seen.</p>

</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
